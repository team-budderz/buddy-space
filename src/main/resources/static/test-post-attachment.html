<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 첨부파일 테스트</title>
    <style>
        #saveContent {
            display: none;
        }
    </style>
</head>
<body>

<h2>1. 로그인</h2>
<input type="text" id="email" placeholder="이메일" />
<input type="password" id="password" placeholder="비밀번호" />
<button onclick="login()">로그인</button>
<p id="loginResult"></p>

<h2>2. 게시글 작성</h2>
<div id="previewContent" contenteditable="true" style="border:1px solid #ccc; padding:10px; width:500px; min-height:200px;"></div><br>
<input type="file" id="fileInput" />
<button onclick="uploadFile()">파일 업로드</button>
<br><br>
<button onclick="submitPost()">게시글 저장</button>

<div id="saveContent"></div>

<h2>3. 저장한 게시글 조회</h2>
<div id="postResult"></div>

<script>
    let accessToken = null;
    const groupId = 1;

    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        fetch("http://localhost:8080/api/users/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message); }))
            .then(data => {
                accessToken = "Bearer " + data.result.accessToken;
                document.getElementById("loginResult").innerText = "로그인 성공!";
            })
            .catch(err => {
                document.getElementById("loginResult").innerText = "로그인 실패: " + err.message;
            });
    }

    function uploadFile() {
        const file = document.getElementById("fileInput").files[0];
        const formData = new FormData();
        formData.append("file", file);

        fetch(`http://localhost:8080/api/groups/${groupId}/post-files`, {
            method: "POST",
            headers: { "Authorization": accessToken },
            body: formData
        })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message); }))
            .then(data => {
                const attachmentId = data.result.id;
                const contentType = data.result.type || "";
                const fileName = data.result.filename || "";
                const url = data.result.url;
                const thumbnailUrl = data.result.thumbnailUrl;

                let saveTag = "";

                if (contentType.startsWith("image/")) {
                    saveTag = `<img data-id="${attachmentId}" />`;
                } else if (contentType.startsWith("video/")) {
                    saveTag = `<video data-id="${attachmentId}"></video>`;
                } else {
                    saveTag = `<a data-id="${attachmentId}"></a>`;
                }

                // 동적 태그 생성 및 미리보기 정보 채워넣기
                const wrapper = document.createElement("div");
                wrapper.innerHTML = saveTag;

                if (contentType.startsWith("image/")) {
                    const img = wrapper.querySelector("img");
                    img.setAttribute("src", url);
                    img.setAttribute("width", "200");
                } else if (contentType.startsWith("video/")) {
                    const video = wrapper.querySelector("video");
                    video.setAttribute("controls", "");
                    video.setAttribute("poster", thumbnailUrl || "");
                    video.setAttribute("width", "300");
                    const source = document.createElement("source");
                    source.setAttribute("src", url);
                    source.setAttribute("type", contentType);
                    video.appendChild(source);
                } else {
                    const a = wrapper.querySelector("a");
                    a.setAttribute("href", url);
                    a.setAttribute("target", "_blank");
                    a.innerText = fileName;
                }

                const previewDiv = document.getElementById("previewContent");
                previewDiv.appendChild(wrapper.firstChild);
                previewDiv.appendChild(document.createElement("br"));
            })
            .catch(err => {
                alert("업로드 실패: " + err.message);
            });
    }

    function submitPost() {
        const previewDiv = document.getElementById("previewContent");
        const saveDiv = document.getElementById("saveContent");

        const cloned = previewDiv.cloneNode(true);

        // <img> 정제
        cloned.querySelectorAll("img").forEach(img => {
            const id = img.getAttribute("data-id");
            if (id) {
                const newImg = document.createElement("img");
                newImg.setAttribute("data-id", id);
                img.replaceWith(newImg);
            }
        });

        // <video> 정제
        cloned.querySelectorAll("video").forEach(video => {
            const id = video.getAttribute("data-id");
            if (id) {
                const newVideo = document.createElement("video");
                newVideo.setAttribute("data-id", id);
                video.replaceWith(newVideo);
            }
        });

        // <a> 정제
        cloned.querySelectorAll("a").forEach(a => {
            const id = a.getAttribute("data-id");
            if (id) {
                const newA = document.createElement("a");
                newA.setAttribute("data-id", id);
                a.replaceWith(newA);
            }
        });

        saveDiv.innerHTML = cloned.innerHTML;

        const postData = {
            content: saveDiv.innerHTML,
            isNotice: false,
            reserveAt: null
        };

        fetch(`http://localhost:8080/api/group/${groupId}/posts`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": accessToken
            },
            body: JSON.stringify(postData)
        })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message); }))
            .then(data => {
                alert("게시글 저장 성공");
                getPost(data.result.postId);
            })
            .catch(err => {
                alert("저장 실패: " + err.message);
            });
    }

    function getPost(postId) {
        fetch(`http://localhost:8080/api/group/${groupId}/posts/${postId}`, {
            method: "GET",
            headers: {
                "Authorization": accessToken
            }
        })
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message); }))
            .then(data => {
                const post = data.result;
                const div = document.getElementById("postResult");
                div.innerHTML = `
                <p><strong>작성자:</strong> ${post.userName}</p>
                <p><strong>작성일:</strong> ${post.createdAt}</p>
                <div><strong>내용:</strong><br>${post.renderedContent}</div>
                `;
            })
            .catch(err => {
                alert("게시글 조회 실패: " + err.message);
            });
    }
</script>

</body>
</html>