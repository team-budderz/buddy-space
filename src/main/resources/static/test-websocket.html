<!-- test-websocket.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>WebSocket STOMP SockJS 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h1>WebSocket STOMP 테스트</h1>

<button onclick="connect()">Connect</button>
<button onclick="disconnect()">Disconnect</button>

<br><br>

<input type="text" id="message" placeholder="메시지 입력" />
<button onclick="sendMessage()">Send</button>

<ul id="messages"></ul>

<script>
    let stompClient = null;

    function connect() {
        const token = localStorage.getItem("accessToken");

        if (!token) {
            alert("토큰이 없습니다. 먼저 로그인 후 다시 시도하세요.");
            return;
        }

        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { Authorization: 'Bearer ' + token },
            onConnected,
            onError
        );
    }


    function onConnected(frame) {
        console.log('✅ STOMP CONNECTED', frame);
        // 구독
        stompClient.subscribe('/sub/chat/room/1', function (msg) {
            console.log("받은 메시지:", msg.body);
            showMessage(msg.body);
        });
    }

    function onError(error) {
        console.error('❌ STOMP error', error);
    }

    function disconnect() {
        if (stompClient) stompClient.disconnect();
        console.log('Disconnected');
    }

    function sendMessage() {
        const content = document.getElementById("message").value.trim();
        if (!content) return;

        stompClient.send("/pub/chat/message", {}, JSON.stringify({
            roomId: 1,
            messageType: "TEXT",
            content
        }));

        document.getElementById("message").value = "";
    }

    function showMessage(text) {
        const msg = JSON.parse(text);
        const li = document.createElement("li");
        li.textContent = `[${msg.messageType}] ${msg.content}`;
        document.getElementById("messages").appendChild(li);
    }
</script>

</body>
</html>
